library(uwot)
context("perplexity")


# Full neighbor values based on comparison with smallvis results

iris10_nn10 <- dist_nn(dist(iris10), k = 10)
res <- calc_row_probabilities(iris10_nn10$dist, iris10_nn10$idx, perplexity = 4, verbose = FALSE,
                              ret_extra = TRUE)

expected_sigmas <- c(0.3252233, 0.2679755, 0.1817380, 0.1751287, 0.3280264, 0.4861266, 0.2463306, 0.2422687, 0.3463065, 0.2411619)

P_row <- matrix(c(
  0.000000e+00, 0.03254778, 0.04322171, 0.009522236, 4.179712e-01, 1.389888e-02, 0.03932256, 0.3802648571, 1.633620e-04, 0.06308741,
  1.336594e-02, 0.00000000, 0.21654628, 0.163906282, 4.387114e-03, 4.819686e-08, 0.02029701, 0.0618376045, 2.029701e-02, 0.49936271,
  9.381792e-04, 0.16129295, 0.00000000, 0.400023323, 9.381792e-04, 7.502536e-16, 0.29552576, 0.0143118438, 7.811162e-03, 0.11915861,
  3.912338e-06, 0.09596260, 0.48990584, 0.000000000, 3.912338e-06, 1.913538e-19, 0.09596260, 0.0009992458, 1.842071e-01, 0.13295484,
  4.498193e-01, 0.01739352, 0.04834632, 0.010928997, 0.000000e+00, 1.584988e-02, 0.07694327, 0.3403719404, 2.009270e-04, 0.04014584,
  3.505169e-01, 0.01137979, 0.01187167, 0.005542650, 3.505169e-01, 0.000000e+00, 0.02652673, 0.2200679860, 2.131340e-04, 0.02336422,
  1.894222e-02, 0.02233591, 0.51154696, 0.264602894, 5.091753e-02, 1.331050e-07, 0.00000000, 0.0834805843, 1.155348e-02, 0.03662029,
  4.467317e-01, 0.03468598, 0.04112888, 0.010524562, 3.177321e-01, 1.763500e-04, 0.03468598, 0.0000000000, 1.925167e-05, 0.11431520,
  8.735213e-04, 0.11962802, 0.21444851, 0.493687059, 8.735213e-04, 2.023140e-08, 0.08570012, 0.0059452421, 0.000000e+00, 0.07884399,
  1.960264e-02, 0.51417681, 0.15431120, 0.154311203, 6.986716e-03, 2.081749e-08, 0.01650597, 0.1299343209, 4.171117e-03, 0.00000000
), nrow = 10, byrow = TRUE)

expect_equal(res$sigma, expected_sigmas, tol = 1e-5)
expect_equal(as.matrix(res$P), P_row, tol = 1e-5, check.attributes = FALSE)

P_joint <- matrix(c(
  0.000000e+00, 0.0022956859, 0.0022079944, 0.0004763074, 4.338953e-02, 1.822079e-02, 0.002913239, 0.0413498285, 5.184416e-05, 0.004134502,
  2.295686e-03, 0.0000000000, 0.0188919615, 0.0129934442, 1.089032e-03, 5.689921e-04, 0.002131646, 0.0048261793, 6.996252e-03, 0.050676976,
  2.207994e-03, 0.0188919615, 0.0000000000, 0.0444964580, 2.464225e-03, 5.935835e-04, 0.040353636, 0.0027720360, 1.111298e-02, 0.013673490,
  4.763074e-04, 0.0129934442, 0.0444964580, 0.0000000000, 5.466455e-04, 2.771325e-04, 0.018028275, 0.0005761904, 3.389471e-02, 0.014363302,
  4.338953e-02, 0.0010890318, 0.0024642250, 0.0005466455, 0.000000e+00, 1.831834e-02, 0.006393040, 0.0329052015, 5.372241e-05, 0.002356628,
  1.822079e-02, 0.0005689921, 0.0005935835, 0.0002771325, 1.831834e-02, 0.000000e+00, 0.001326343, 0.0110122168, 1.065771e-05, 0.001168212,
  2.913239e-03, 0.0021316462, 0.0403536359, 0.0180282748, 6.393040e-03, 1.326343e-03, 0.000000000, 0.0059083283, 4.862680e-03, 0.002656313,
  4.134983e-02, 0.0048261793, 0.0027720360, 0.0005761904, 3.290520e-02, 1.101222e-02, 0.005908328, 0.0000000000, 2.982247e-04, 0.012212476,
  5.184416e-05, 0.0069962518, 0.0111129834, 0.0338947056, 5.372241e-05, 1.065771e-05, 0.004862680, 0.0002982247, 0.000000e+00, 0.004150755,
  4.134502e-03, 0.0506769759, 0.0136734904, 0.0143633019, 2.356628e-03, 1.168212e-03, 0.002656313, 0.0122124758, 4.150755e-03, 0.000000000
), nrow = 10, byrow = TRUE)

res <- perplexity_similarities(iris10, n_neighbors = 10, perplexity = 4, verbose = FALSE)
expect_true(Matrix::isSymmetric(res))
expect_equal(as.matrix(res), P_joint, tol = 1e-5, check.attributes = FALSE)

P_joint_6nn <- matrix(c(
   0,           0,           0.004227396, 0,          0.038581602, 0.016370215, 0.003972948, 0.037491042, 0,           0.007253571,
   0,           0,           0.020541010, 0.01457322, 0,           0,           0,           0.008117719, 0.008608916, 0.043891243,
   0.004227396, 0.020541010, 0,           0.04314614, 0.004242199, 0,           0.036275982, 0.004791681, 0.010952319, 0.015666352,
   0,           0.014573224, 0.043146139, 0,          0,           0,           0.018725165, 0,           0.032811238, 0.015644628,
   0.038581602, 0,           0.004242199, 0,          0,           0.016370215, 0.010365583, 0.031963895, 0,           0.003730662,
   0.016370215, 0,           0,           0,          0.016370215, 0,           0.002795087, 0.011902114, 0,           0.002562369,
   0.003972948, 0,           0.036275982, 0.01872517, 0.010365583, 0.002795087, 0,           0.006321792, 0.004717900, 0.003609179,
   0.037491042, 0.008117719, 0.004791681, 0,          0.031963895, 0.011902114, 0.006321792, 0,           0,           0.015406444,
   0,           0.008608916, 0.010952319, 0.03281124, 0,           0,           0.004717900, 0,           0,           0.004370167,
   0.007253571, 0.043891243, 0.015666352, 0.01564463, 0.003730662, 0.002562369, 0.003609179, 0.015406444, 0.004370167, 0
), nrow = 10, byrow = TRUE)
res <- perplexity_similarities(iris10, n_neighbors = 6, perplexity = 4, verbose = FALSE)
expect_true(Matrix::isSymmetric(res))
expect_equal(as.matrix(res), P_joint_6nn, tol = 1e-5, check.attributes = FALSE)
