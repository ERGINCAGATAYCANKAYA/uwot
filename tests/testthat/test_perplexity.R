library(uwot)
context("perplexity")

iris10_nn10 <- dist_nn(dist(iris10), k = 10)
res <- calc_row_probabilities(iris10_nn10$dist, iris10_nn10$idx, perplexity = 4, verbose = FALSE,
                              ret_extra = TRUE)

expected_sigmas <- c(0.3875746, 0.3328844, 0.2267537, 0.2282964, 0.3870091,
                     0.3757562, 0.2841583, 0.3104109, 0.3610148, 0.3111382)

P_row <- matrix(c(
  0,            0.03171423, 0.03836934, 0.015293312, 0.4459993719, 1.887808e-02, 0.03596676, 0.360945179, 0.0024697870, 0.05036394,
  0.0203963107, 0,          0.17552762, 0.131902755, 0.0108679869, 1.395606e-04, 0.02640570, 0.057191264, 0.0264057002, 0.55116310,
  0.0024604262, 0.14586201, 0,          0.425529218, 0.0024604262, 3.331679e-08, 0.29050761, 0.016417752, 0.0103789023, 0.10638362,
  0.0002198512, 0.09520517, 0.50258508, 0,           0.0002198512, 1.058942e-08, 0.09520517, 0.003766787, 0.1747798432, 0.12801824,
  0.5039199534, 0.02231809, 0.04304331, 0.017110320, 0,            2.113397e-02, 0.06076521, 0.291108246, 0.0027485742, 0.03785234,
  0.3601068466, 0.01250642, 0.01291996, 0.007335994, 0.3601068081, 0,            0.02466391, 0.199256986, 0.0009192125, 0.02218386,
  0.0229019025, 0.02582943, 0.53902919, 0.234844835, 0.0489649827, 6.354306e-05, 0,          0.074596877, 0.0161694610, 0.03759978,
  0.4862075166, 0.03591308, 0.04065644, 0.016364282, 0.2881720627, 2.053337e-03, 0.03591308, 0,           0.0008289510, 0.09389124,
  0.0044965927, 0.10615362, 0.18730939, 0.531343206, 0.0044965927, 7.274805e-05, 0.07941601, 0.012625439, 0,            0.07408640,
  0.0263765949, 0.56027007, 0.12787054, 0.127870540, 0.0141761973, 9.876399e-05, 0.02365523, 0.109025339, 0.0106567183, 0
), nrow = 10, byrow = TRUE)

expect_equal(res$sigma, expected_sigmas, tol = 1e-5)
expect_equal(as.matrix(res$P), P_row, check.attributes = FALSE)

